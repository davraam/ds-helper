<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dsHelper">
<title>Conducting mixed effect/trajectory analysis using DataSHIELD • dsHelper</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Conducting mixed effect/trajectory analysis using DataSHIELD">
<meta property="og:description" content="dsHelper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dsHelper</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/TROUBLESHOOTING.html">Troubleshooting</a>
    <a class="dropdown-item" href="../articles/ds-helper-main-vignette.html">Descriptive functions</a>
    <a class="dropdown-item" href="../articles/ds-helper-trajectories-vignette.html">Conducting mixed effect/trajectory analysis using DataSHIELD</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/lifecycle-project/ds-helper/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Conducting mixed effect/trajectory analysis using DataSHIELD</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lifecycle-project/ds-helper/blob/HEAD/vignettes/ds-helper-trajectories-vignette.Rmd" class="external-link"><code>vignettes/ds-helper-trajectories-vignette.Rmd</code></a></small>
      <div class="d-none name"><code>ds-helper-trajectories-vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>This tutorial will demonstrate how to model trajectories in DataSHIELD using repeated measures data from multiple cohorts.</p>
<p>This tutorial draws on the following papers/tutorials:</p>
<ol style="list-style-type: decimal">
<li><p>Hughes, R., Tilling, K. &amp; Lawlor, D. Combining longitudinal data from different cohorts to examine the life-course trajectory. Preprint available on medrxiv: <a href="https://doi.org/10.1101/2020.11.24.20237669" class="external-link uri">https://doi.org/10.1101/2020.11.24.20237669</a></p></li>
<li><p>Tilling K, Macdonald-Wallis C, Lawlor DA, Hughes RA, Howe LD. Modelling childhood growth using fractional polynomials and linear splines. Ann Nutr Metab. 2014;65(2-3):129-38. <a href="https://doi.org/10.1159/000362695" class="external-link uri">https://doi.org/10.1159/000362695</a>.</p></li>
<li><p>Centre for Multilevel Modelling online course. <a href="http://www.bristol.ac.uk/cmm/learning/online-course/" class="external-link uri">http://www.bristol.ac.uk/cmm/learning/online-course/</a></p></li>
</ol>
<p>You will use simulated data to replicate part of the analysis from Hughes et al. cited above. It would be helpful to read this tutorial in conjuncture with this paper.</p>
<p>Please note that not all the methods used in Hughes et al. are available in DataSHIELD. Currently it is not possible to do 1-stage meta-analysis of mixed effects models. All of these are in the pipeline and this tutorial will be extended when these methods become available.</p>
<p>Do spline models!</p>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>We will be working with simulated repeated measures data for four cohorts: (i) Alspac, (ii) BCG, (iii) Born in Bradford &amp; (iv) Probit.</p>
</div>
<div class="section level3">
<h3 id="aims-of-the-analysis">Aims of the analysis<a class="anchor" aria-label="anchor" href="#aims-of-the-analysis"></a>
</h3>
<p>Our research aims for today are:</p>
<ol style="list-style-type: decimal">
<li>To model child weight trajectories over time for four cohorts</li>
<li>To model sex differences in weight trajectories</li>
<li>To combine these trajectories by 2-stage meta-analysis</li>
</ol>
<p>Let’s get started.</p>
</div>
</div>
<div class="section level2">
<h2 id="installing-and-loading-packages">Installing and loading packages<a class="anchor" aria-label="anchor" href="#installing-and-loading-packages"></a>
</h2>
<p>First you need to install some packages are used in tutorial. Even if you have previously installed them it is worth doing this again to ensure that you have the latest versions.</p>
<p>If prompted to update packages, select option ‘none’.</p>
<p>First install the package ‘remotes’ which contains the function ‘install_github’.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install.packages("remotes")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org" class="external-link">remotes</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install_github("datashield/DSI")</span></span>
<span><span class="co">#install_github("datashield/dsBaseClient")</span></span>
<span><span class="co">#install_github("lifecycle-project/ds-helper", ref = "dev")</span></span>
<span><span class="co">#install.packages("DSMolgenisArmadillo")</span></span>
<span><span class="co">#install.packages("tidyverse")</span></span></code></pre></div>
<p>Now we load these packages.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">dsBaseClient</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/datashield/DSI/" class="external-link">DSI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/molgenis/molgenis-r-datashield/" class="external-link">DSMolgenisArmadillo</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lifecycle-project/ds-helper/" class="external-link">dsHelper</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<p>A couple of things to note:</p>
<ol style="list-style-type: decimal">
<li><p>I use a lot of the tidyverse packages as I find them very efficient and they make the code more readable. If any syntax is unclear just ask!</p></li>
<li><p>I also use a number of functions from a package called dsHelper. This was written by me and Sido Haakma to make analysis in DataSHIELD more straightforward. Any problems with these functions just let us know.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="logging-in-and-assigning-data">Logging in and assigning data<a class="anchor" aria-label="anchor" href="#logging-in-and-assigning-data"></a>
</h2>
<p>The simulated data is held on a remote server. To access it, you first request a ‘token’ which contains the login details. You then use this to login and assign the data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://armadillo-demo.molgenis.net/"</span></span>
<span><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://molgenis.github.io/molgenis-r-datashield/reference/armadillo.get_token.html" class="external-link">armadillo.get_token</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">builder</span> <span class="op">&lt;-</span> <span class="fu">DSI</span><span class="fu">::</span><span class="fu"><a href="https://datashield.github.io/DSI/reference/newDSLoginBuilder.html" class="external-link">newDSLoginBuilder</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">builder</span><span class="op">$</span><span class="fu">append</span><span class="op">(</span></span>
<span>server <span class="op">=</span> <span class="st">"alspac"</span>,</span>
<span>url <span class="op">=</span> <span class="va">url</span>,</span>
<span>table <span class="op">=</span> <span class="st">"trajectories/data/alspac"</span>,</span>
<span>token <span class="op">=</span> <span class="va">token</span>,</span>
<span>driver <span class="op">=</span> <span class="st">"ArmadilloDriver"</span>, </span>
<span>profile <span class="op">=</span> <span class="st">"xenon"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">builder</span><span class="op">$</span><span class="fu">append</span><span class="op">(</span></span>
<span>server <span class="op">=</span> <span class="st">"bcg"</span>,</span>
<span>url <span class="op">=</span> <span class="va">url</span>,</span>
<span>table <span class="op">=</span> <span class="st">"trajectories/data/bcg"</span>,</span>
<span>token <span class="op">=</span> <span class="va">token</span>,</span>
<span>driver <span class="op">=</span> <span class="st">"ArmadilloDriver"</span>, </span>
<span>profile <span class="op">=</span> <span class="st">"xenon"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">builder</span><span class="op">$</span><span class="fu">append</span><span class="op">(</span></span>
<span>server <span class="op">=</span> <span class="st">"bib"</span>,</span>
<span>url <span class="op">=</span> <span class="va">url</span>,</span>
<span>table <span class="op">=</span> <span class="st">"trajectories/data/bib"</span>,</span>
<span>token <span class="op">=</span> <span class="va">token</span>,</span>
<span>driver <span class="op">=</span> <span class="st">"ArmadilloDriver"</span>, </span>
<span>profile <span class="op">=</span> <span class="st">"xenon"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">builder</span><span class="op">$</span><span class="fu">append</span><span class="op">(</span></span>
<span>server <span class="op">=</span> <span class="st">"probit"</span>,</span>
<span>url <span class="op">=</span> <span class="va">url</span>,</span>
<span>table <span class="op">=</span> <span class="st">"trajectories/data/probit"</span>,</span>
<span>token <span class="op">=</span> <span class="va">token</span>,</span>
<span>driver <span class="op">=</span> <span class="st">"ArmadilloDriver"</span>, </span>
<span>profile <span class="op">=</span> <span class="st">"xenon"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">logindata</span> <span class="op">&lt;-</span> <span class="va">builder</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">conns</span> <span class="op">&lt;-</span> <span class="fu">DSI</span><span class="fu">::</span><span class="fu"><a href="https://datashield.github.io/DSI/reference/datashield.login.html" class="external-link">datashield.login</a></span><span class="op">(</span>logins <span class="op">=</span> <span class="va">logindata</span>, assign <span class="op">=</span> <span class="cn">T</span>, symbol <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
<p>We can check that this has worked. You should see that each cohort has one dataframe called “data”, which contains 7 variables.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.summary.html" class="external-link">ds.summary</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $alspac</span></span>
<span><span class="co">## $alspac$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $alspac$`number of rows`</span></span>
<span><span class="co">## [1] 129681</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $alspac$`number of columns`</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $alspac$`variables held`</span></span>
<span><span class="co">## [1] "id"                 "age"                "sex"                "ethnicity"          "father_socialclass" "mother_education"  </span></span>
<span><span class="co">## [7] "weight"            </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bcg</span></span>
<span><span class="co">## $bcg$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bcg$`number of rows`</span></span>
<span><span class="co">## [1] 12724</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bcg$`number of columns`</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bcg$`variables held`</span></span>
<span><span class="co">## [1] "id"                 "age"                "sex"                "ethnicity"          "father_socialclass" "mother_education"  </span></span>
<span><span class="co">## [7] "weight"            </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bib</span></span>
<span><span class="co">## $bib$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bib$`number of rows`</span></span>
<span><span class="co">## [1] 68864</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bib$`number of columns`</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bib$`variables held`</span></span>
<span><span class="co">## [1] "id"                 "age"                "sex"                "ethnicity"          "father_socialclass" "mother_education"  </span></span>
<span><span class="co">## [7] "weight"            </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $probit</span></span>
<span><span class="co">## $probit$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $probit$`number of rows`</span></span>
<span><span class="co">## [1] 191224</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $probit$`number of columns`</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $probit$`variables held`</span></span>
<span><span class="co">## [1] "id"                 "age"                "sex"                "ethnicity"          "father_socialclass" "mother_education"  </span></span>
<span><span class="co">## [7] "weight"</span></span></code></pre>
<p>We wont be using all of the variables today, however if you want to come back and use this data to try out more complicated models we’ll keep it online.</p>
</div>
<div class="section level2">
<h2 id="part-1-visualising-the-data">Part 1: Visualising the data<a class="anchor" aria-label="anchor" href="#part-1-visualising-the-data"></a>
</h2>
<div class="section level3">
<h3 id="scatter-plots-of-child-weight-by-age">Scatter plots of child weight by age<a class="anchor" aria-label="anchor" href="#scatter-plots-of-child-weight-by-age"></a>
</h3>
<p>Let’s start off by looking at our repeated measures weight data for each cohort. We can make scatter plots with age on the x-axis and weight on the y-axis.</p>
<p>Note that the values that you see are anonymised - they are a non-disclosive approximation of the original values.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.scatterPlot.html" class="external-link">ds.scatterPlot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"data$age"</span>, y <span class="op">=</span> <span class="st">"data$weight"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="scatter-1.png" alt=""><p class="caption">plot of chunk scatter</p>
</div>
<pre><code><span><span class="co">## [1] "Split plot created"</span></span></code></pre>
<p>What are you initial thoughts about the data?</p>
</div>
<div class="section level3">
<h3 id="mean-observed-weight-by-age">Mean observed weight by age<a class="anchor" aria-label="anchor" href="#mean-observed-weight-by-age"></a>
</h3>
<p>Another way to visualise the weight data is to split child age into yearly intervals, and plot the mean on the y-axis with age on the x-axis (see Figure 2 from Hughes et al.).</p>
<p>First of all we need to calculate the mean values for weight at each yearly age band:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.meanByGroup.html">dh.meanByGroup</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    outcome <span class="op">=</span> <span class="st">"weight"</span>, </span>
<span>    group_var <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 55 × 3</span></span>
<span><span class="co">##    cohort   age  mean</span></span>
<span><span class="co">##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac     0  4.64</span></span>
<span><span class="co">##  2 alspac     1  8.78</span></span>
<span><span class="co">##  3 alspac     2 12.8 </span></span>
<span><span class="co">##  4 alspac     3 16.1 </span></span>
<span><span class="co">##  5 alspac     4 17.0 </span></span>
<span><span class="co">##  6 alspac     5 18.4 </span></span>
<span><span class="co">##  7 alspac     6 20.3 </span></span>
<span><span class="co">##  8 alspac     7 24.3 </span></span>
<span><span class="co">##  9 alspac     8 26.5 </span></span>
<span><span class="co">## 10 alspac     9 30.5 </span></span>
<span><span class="co">## 11 alspac    10 35.1 </span></span>
<span><span class="co">## 12 alspac    11 38.8 </span></span>
<span><span class="co">## 13 alspac    12 43.6 </span></span>
<span><span class="co">## 14 alspac    13 49.3 </span></span>
<span><span class="co">## 15 alspac    14 54.6 </span></span>
<span><span class="co">## 16 alspac    15 61.3 </span></span>
<span><span class="co">## 17 alspac    16 63.5 </span></span>
<span><span class="co">## 18 alspac    17 67.0 </span></span>
<span><span class="co">## 19 alspac    18 67.7 </span></span>
<span><span class="co">## 20 alspac    19 70.8 </span></span>
<span><span class="co">## 21 alspac    20 71.8 </span></span>
<span><span class="co">## 22 bcg        0  5.11</span></span>
<span><span class="co">## 23 bcg        1  8.88</span></span>
<span><span class="co">## 24 bcg        2 13.3 </span></span>
<span><span class="co">## 25 bcg        3 15.4 </span></span>
<span><span class="co">## 26 bcg        4 16.4 </span></span>
<span><span class="co">## 27 bcg        5 18.6 </span></span>
<span><span class="co">## 28 bib        0  4.46</span></span>
<span><span class="co">## 29 bib        1  8.11</span></span>
<span><span class="co">## 30 bib        2 13.3 </span></span>
<span><span class="co">## 31 bib        3 16.0 </span></span>
<span><span class="co">## 32 bib        4 17.1 </span></span>
<span><span class="co">## 33 bib        5 18.7 </span></span>
<span><span class="co">## 34 bib        6 22.4 </span></span>
<span><span class="co">## 35 bib        7 27.8 </span></span>
<span><span class="co">## 36 probit     0  4.98</span></span>
<span><span class="co">## 37 probit     1  8.66</span></span>
<span><span class="co">## 38 probit     2 14.0 </span></span>
<span><span class="co">## 39 probit     3 16.4 </span></span>
<span><span class="co">## 40 probit     4 16.8 </span></span>
<span><span class="co">## 41 probit     5 17.8 </span></span>
<span><span class="co">## 42 probit     6 20.8 </span></span>
<span><span class="co">## 43 probit     7 23.6 </span></span>
<span><span class="co">## 44 probit     8 28.0 </span></span>
<span><span class="co">## 45 probit     9 34.6 </span></span>
<span><span class="co">## 46 probit    10 36.1 </span></span>
<span><span class="co">## 47 probit    11 39.8 </span></span>
<span><span class="co">## 48 probit    12 42.1 </span></span>
<span><span class="co">## 49 probit    13 47.1 </span></span>
<span><span class="co">## 50 probit    14 54.0 </span></span>
<span><span class="co">## 51 probit    15 60.1 </span></span>
<span><span class="co">## 52 probit    16 62.4 </span></span>
<span><span class="co">## 53 probit    17 63.2 </span></span>
<span><span class="co">## 54 probit    18 61.6 </span></span>
<span><span class="co">## 55 probit    19 61.0</span></span></code></pre>
<p>Now we have the values locally, we can use any r package to plot these. I like to use ggplot:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#264653"</span>, <span class="st">"#2a9d8f"</span>, <span class="st">"#E9C46A"</span>, <span class="st">"#F4A261"</span>, <span class="st">"#E76F51"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mean_age.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mean_age</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">mean</span>, colour <span class="op">=</span> <span class="va">cohort</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Observed weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">palette</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_age.plot</span></span></code></pre></div>
<div class="figure">
<img src="mean-by-age-plot-1.png" alt=""><p class="caption">plot of chunk mean-by-age-plot-1</p>
</div>
<p>Q: Looking at these two plots, What are your initial thoughts about the pattern of weight change over time?</p>
</div>
<div class="section level3">
<h3 id="describing-the-exposures">Describing the exposures<a class="anchor" aria-label="anchor" href="#describing-the-exposures"></a>
</h3>
<p>DataSHIELD contains the functions ds.summary and ds.table which can be used to describe continuous and categorical variables. However, the output of these is a little tricky to work with. Instead we can use the function ‘dh.getStats’ to extract descriptives in a more usable format.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.getStats.html">dh.getStats</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    vars <span class="op">=</span> <span class="st">"sex"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span></span></code></pre></div>
<pre><code><span><span class="co">## $categorical</span></span>
<span><span class="co">## # A tibble: 0 × 10</span></span>
<span><span class="co">## # ℹ 10 variables: variable &lt;chr&gt;, cohort &lt;chr&gt;, category &lt;chr&gt;, value &lt;dbl&gt;, cohort_n &lt;int&gt;, valid_n &lt;dbl&gt;, missing_n &lt;dbl&gt;, perc_valid &lt;dbl&gt;,</span></span>
<span><span class="co">## #   perc_missing &lt;dbl&gt;, perc_total &lt;dbl&gt;</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $continuous</span></span>
<span><span class="co">## # A tibble: 5 × 15</span></span>
<span><span class="co">##   variable cohort    mean std.dev perc_5 perc_10 perc_25 perc_50 perc_75 perc_90 perc_95 valid_n cohort_n missing_n missing_perc</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">## 1 sex      alspac    0.49     0.5      0       0       0       0       1       1       1  129681   129681         0            0</span></span>
<span><span class="co">## 2 sex      bcg       0.48     0.5      0       0       0       0       1       1       1   12724    12724         0            0</span></span>
<span><span class="co">## 3 sex      bib       0.49     0.5      0       0       0       0       1       1       1   68864    68864         0            0</span></span>
<span><span class="co">## 4 sex      probit    0.48     0.5      0       0       0       0       1       1       1  191224   191224         0            0</span></span>
<span><span class="co">## 5 sex      combined  0.49     0.5      0       0       0       0       1       1       1  402493   402493         0            0</span></span></code></pre>
<p>This gives us a list with two elements corresponding to the continuous and categorical variables. As we didn’t request stats for any continuous variables, the first list is empty.</p>
</div>
<div class="section level3">
<h3 id="some-more-descriptives-that-are-useful-to-have">Some more descriptives that are useful to have<a class="anchor" aria-label="anchor" href="#some-more-descriptives-that-are-useful-to-have"></a>
</h3>
<p>There are other bits of information it is useful to report:</p>
<ul>
<li>Total number of observations</li>
<li>Total number of participants</li>
<li>Min and max age of participants</li>
<li>Median number of measurements per individual</li>
</ul>
<p>We can use the function dh.getRmStats to extract this info. Note that the min and max ages are based on the 5th and 95th percentiles as DataSHIELD doesn’t will not return true minimum and maximums due to disclosure issues.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rm_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.getRmStats.html">dh.getRmStats</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"weight"</span>,</span>
<span>    id_var <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>    age_var <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rm_stats</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 5 × 8</span></span>
<span><span class="co">##   cohort   min_age max_age  n_obs n_participants n_meas_5 n_meas_med n_meas_95</span></span>
<span><span class="co">##   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 alspac         0   15.7  129681          14216     6          9         13  </span></span>
<span><span class="co">## 2 bcg            0    4.99  12724            951    12         14         14  </span></span>
<span><span class="co">## 3 bib            0    4.98  68864          13445     3          5          8  </span></span>
<span><span class="co">## 4 probit         0   15.9  191224          17046     9         11         14  </span></span>
<span><span class="co">## 5 combined       0   13.6  402493          45658     6.36       8.67      11.9</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="part-2-fitting-a-simple-linear-trajectory">Part 2: Fitting a simple linear trajectory<a class="anchor" aria-label="anchor" href="#part-2-fitting-a-simple-linear-trajectory"></a>
</h2>
<div class="section level3">
<h3 id="trajectory-models-prep">Trajectory models: prep<a class="anchor" aria-label="anchor" href="#trajectory-models-prep"></a>
</h3>
<p>Before we can get started, we need to make sure that our id variable is an integer. If we don’t, it breaks. First we create a new object which is an integer version of our ID. We then join this back to our main dataframe.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.asInteger.html" class="external-link">ds.asInteger</a></span><span class="op">(</span></span>
<span>    x.name <span class="op">=</span> <span class="st">"data$id"</span>, </span>
<span>    newobj <span class="op">=</span> <span class="st">"id_int"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.dataFrame.html" class="external-link">ds.dataFrame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data$id"</span>, <span class="st">"data$age"</span>, <span class="st">"data$sex"</span>, <span class="st">"data$ethnicity"</span>, </span>
<span>          <span class="st">"data$father_socialclass"</span>, <span class="st">"data$mother_education"</span>, <span class="st">"data$weight"</span>,</span>
<span>          <span class="st">"id_int"</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">F</span>,</span>
<span>    newobj <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="specifying-the-model">Specifying the model<a class="anchor" aria-label="anchor" href="#specifying-the-model"></a>
</h3>
<p>First we fit a model with weight predicted by four terms: an intercept (1), age, sex and the interaction between age and sex. These terms are our ‘fixed effects’, and comprise the first half of the formula below. They are specified in the same way as you would write a formula in a standard regression model.</p>
<p>In the second half of the formula below we specify our random effects. This is where we provide information about how we believe the data to be clustered.</p>
<p>The variable to the right of the vertical line is our ID variable. This specifies that we want to treat each invidual as a separate cluster, because we believe their measurements will be correlated. This is a plausible hypothesis: for example if my height is a lot higher than average at age 5, it is likely to also be higher than average at age 10. We can describe this as a 2-level clustering, with weight measurements (level 1) clustered within individuals (level 2).</p>
<p>The variables to the left of the vertical line specify which extra parameters we want to estimate for each individual. Or to put it another way, it specifies which parameters we allow to vary for each individual.</p>
<p>If we just specify “1”, then in addition to calculating an overall intercept, we also calculate an intercept for each individual. This provides us with information about the variability between individuals in their starting weight. This is called a random intercept model.</p>
<p>If we specifed “1 + age”, then in addition we would calculate a separate slope for each individual. This would provide us with information about how the gradient of the trajectory varies between individuals. This is called a random slope model.</p>
<p>Here we start with a random intercept model. Understand what you are doing is the difficult bit; fitting the model is straightfoward:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.lmerSLMA.html" class="external-link">ds.lmerSLMA</a></span><span class="op">(</span></span>
<span>    dataName <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  formula <span class="op">=</span> <span class="st">"weight ~ 1 + age + sex + age*sex + (1|id_int)"</span>, </span>
<span>  datasources <span class="op">=</span> <span class="va">conns</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.fit</span><span class="op">$</span><span class="va">output.summary</span></span></code></pre></div>
<pre><code><span><span class="co">## $study1</span></span>
<span><span class="co">## Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">## Formula: weight ~ 1 + age + sex + age * sex + (1 | id_int)</span></span>
<span><span class="co">##    Data: dataDF</span></span>
<span><span class="co">## Weights: weights.to.use</span></span>
<span><span class="co">##  Offset: offset.to.use</span></span>
<span><span class="co">## Control: control.obj</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML criterion at convergence: 839458.6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">##     NA     NA     NA     NA     NA </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">##  id_int   (Intercept) 14.77    3.843   </span></span>
<span><span class="co">##  Residual             31.68    5.628   </span></span>
<span><span class="co">## Number of obs: 129681, groups:  id_int, 14216</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##              Estimate Std. Error t value</span></span>
<span><span class="co">## (Intercept)  3.869135   0.056184  68.866</span></span>
<span><span class="co">## age          3.534366   0.004078 866.797</span></span>
<span><span class="co">## sex          0.336620   0.080317   4.191</span></span>
<span><span class="co">## age:sex     -0.200629   0.005789 -34.655</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##         (Intr) age    sex   </span></span>
<span><span class="co">## age     -0.445              </span></span>
<span><span class="co">## sex     -0.700  0.311       </span></span>
<span><span class="co">## age:sex  0.313 -0.704 -0.443</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $study2</span></span>
<span><span class="co">## Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">## Formula: weight ~ 1 + age + sex + age * sex + (1 | id_int)</span></span>
<span><span class="co">##    Data: dataDF</span></span>
<span><span class="co">## Weights: weights.to.use</span></span>
<span><span class="co">##  Offset: offset.to.use</span></span>
<span><span class="co">## Control: control.obj</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML criterion at convergence: 54369.4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">##     NA     NA     NA     NA     NA </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">##  id_int   (Intercept) 1.250    1.118   </span></span>
<span><span class="co">##  Residual             3.692    1.921   </span></span>
<span><span class="co">## Number of obs: 12724, groups:  id_int, 951</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##             Estimate Std. Error t value</span></span>
<span><span class="co">## (Intercept)  6.03409    0.06151  98.097</span></span>
<span><span class="co">## age          2.85790    0.01411 202.581</span></span>
<span><span class="co">## sex         -0.54661    0.09028  -6.055</span></span>
<span><span class="co">## age:sex      0.03661    0.02049   1.787</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##         (Intr) age    sex   </span></span>
<span><span class="co">## age     -0.455              </span></span>
<span><span class="co">## sex     -0.681  0.310       </span></span>
<span><span class="co">## age:sex  0.313 -0.688 -0.456</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $study3</span></span>
<span><span class="co">## Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">## Formula: weight ~ 1 + age + sex + age * sex + (1 | id_int)</span></span>
<span><span class="co">##    Data: dataDF</span></span>
<span><span class="co">## Weights: weights.to.use</span></span>
<span><span class="co">##  Offset: offset.to.use</span></span>
<span><span class="co">## Control: control.obj</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML criterion at convergence: 292805.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">##     NA     NA     NA     NA     NA </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">##  id_int   (Intercept) 0.6142   0.7837  </span></span>
<span><span class="co">##  Residual             3.6480   1.9100  </span></span>
<span><span class="co">## Number of obs: 68864, groups:  id_int, 13445</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##              Estimate Std. Error t value</span></span>
<span><span class="co">## (Intercept)  5.089372   0.016491 308.613</span></span>
<span><span class="co">## age          3.119718   0.005986 521.136</span></span>
<span><span class="co">## sex         -0.394888   0.023685 -16.672</span></span>
<span><span class="co">## age:sex      0.004995   0.008556   0.584</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##         (Intr) age    sex   </span></span>
<span><span class="co">## age     -0.528              </span></span>
<span><span class="co">## sex     -0.696  0.368       </span></span>
<span><span class="co">## age:sex  0.369 -0.700 -0.529</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $study4</span></span>
<span><span class="co">## Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">## Formula: weight ~ 1 + age + sex + age * sex + (1 | id_int)</span></span>
<span><span class="co">##    Data: dataDF</span></span>
<span><span class="co">## Weights: weights.to.use</span></span>
<span><span class="co">##  Offset: offset.to.use</span></span>
<span><span class="co">## Control: control.obj</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML criterion at convergence: 1138299</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">##     NA     NA     NA     NA     NA </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">##  id_int   (Intercept)  3.402   1.844   </span></span>
<span><span class="co">##  Residual             20.521   4.530   </span></span>
<span><span class="co">## Number of obs: 191224, groups:  id_int, 17046</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##              Estimate Std. Error  t value</span></span>
<span><span class="co">## (Intercept)  4.689392   0.026376  177.793</span></span>
<span><span class="co">## age          3.455656   0.003041 1136.282</span></span>
<span><span class="co">## sex          0.013923   0.038018    0.366</span></span>
<span><span class="co">## age:sex     -0.240527   0.004382  -54.889</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##         (Intr) age    sex   </span></span>
<span><span class="co">## age     -0.381              </span></span>
<span><span class="co">## sex     -0.694  0.264       </span></span>
<span><span class="co">## age:sex  0.264 -0.694 -0.381</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $input.beta.matrix.for.SLMA</span></span>
<span><span class="co">##             betas study 1 betas study 2 betas study 3 betas study 4</span></span>
<span><span class="co">## (Intercept)     3.8691347    6.03408780   5.089372058    4.68939189</span></span>
<span><span class="co">## age             3.5343657    2.85790465   3.119717700    3.45565555</span></span>
<span><span class="co">## sex             0.3366204   -0.54660715  -0.394887544    0.01392347</span></span>
<span><span class="co">## age:sex        -0.2006292    0.03661021   0.004995405   -0.24052747</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $input.se.matrix.for.SLMA</span></span>
<span><span class="co">##             ses study 1 ses study 2 ses study 3 ses study 4</span></span>
<span><span class="co">## (Intercept) 0.056183657  0.06151162 0.016491091 0.026375527</span></span>
<span><span class="co">## age         0.004077501  0.01410748 0.005986375 0.003041196</span></span>
<span><span class="co">## sex         0.080317421  0.09027731 0.023685373 0.038017878</span></span>
<span><span class="co">## age:sex     0.005789246  0.02049084 0.008556005 0.004382080</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="exploring-the-output">Exploring the output<a class="anchor" aria-label="anchor" href="#exploring-the-output"></a>
</h3>
<p>We can see the coefficients for the fixed and random parts of our model directly from the model object.</p>
<p>Fixed effects coefficients for each cohort are here:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.fit</span><span class="op">$</span><span class="va">betamatrix.valid</span></span></code></pre></div>
<pre><code><span><span class="co">##             betas study 1 betas study 2 betas study 3 betas study 4</span></span>
<span><span class="co">## (Intercept)     3.8691347    6.03408780   5.089372058    4.68939189</span></span>
<span><span class="co">## age             3.5343657    2.85790465   3.119717700    3.45565555</span></span>
<span><span class="co">## sex             0.3366204   -0.54660715  -0.394887544    0.01392347</span></span>
<span><span class="co">## age:sex        -0.2006292    0.03661021   0.004995405   -0.24052747</span></span></code></pre>
<p>The pooled estimates are here:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.fit</span><span class="op">$</span><span class="va">SLMA.pooled.ests.matrix</span></span></code></pre></div>
<pre><code><span><span class="co">##              pooled.ML      se.ML pooled.REML    se.REML  pooled.FE       se.FE</span></span>
<span><span class="co">## (Intercept)  4.9201754 0.38859060   4.9202557 0.44896972  4.9643913 0.013250416</span></span>
<span><span class="co">## age          3.2421628 0.13538495   3.2420998 0.15635197  3.4176657 0.002229407</span></span>
<span><span class="co">## sex         -0.1477761 0.17066919  -0.1477464 0.19787562 -0.2576757 0.019061879</span></span>
<span><span class="co">## age:sex     -0.1008701 0.06092812  -0.1006258 0.07037899 -0.1873971 0.003195114</span></span></code></pre>
<p>And the details of the random effects are here:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.fit</span><span class="op">$</span><span class="va">output.summary</span><span class="op">$</span><span class="va">study1</span><span class="op">$</span><span class="va">varcor</span></span></code></pre></div>
<pre><code><span><span class="co">##  Groups   Name        Std.Dev.</span></span>
<span><span class="co">##  id_int   (Intercept) 3.8426  </span></span>
<span><span class="co">##  Residual             5.6282</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="a-neater-way">A neater way<a class="anchor" aria-label="anchor" href="#a-neater-way"></a>
</h3>
<p>I find these objects a little fiddly to work with (you may not). You can also use the dsHelper function to extract the coefficients.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.lmTab.html">dh.lmTab</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model1.fit</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"lmer_slma"</span>, </span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span>, </span>
<span>    ci_format <span class="op">=</span> <span class="st">"separate"</span>, </span>
<span>    direction <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s explore there in more detail</p>
<div class="section level4">
<h4 id="fixed-effects">Fixed effects<a class="anchor" aria-label="anchor" href="#fixed-effects"></a>
</h4>
<p>The fixed effects are analogous to your coefficients from a linear regression model.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.coef</span><span class="op">$</span><span class="va">fixed</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 20 × 9</span></span>
<span><span class="co">##    cohort   variable    est    se pvalue  n_obs n_coh lowci uppci</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac   intercept  3.87  0.06     NA 129681     1  3.76  3.98</span></span>
<span><span class="co">##  2 alspac   age        3.53  0        NA 129681     1  3.53  3.54</span></span>
<span><span class="co">##  3 alspac   sex        0.34  0.08     NA 129681     1  0.18  0.49</span></span>
<span><span class="co">##  4 alspac   age:sex   -0.2   0.01     NA 129681     1 -0.21 -0.19</span></span>
<span><span class="co">##  5 bcg      intercept  6.03  0.06     NA  12724     1  5.91  6.15</span></span>
<span><span class="co">##  6 bcg      age        2.86  0.01     NA  12724     1  2.83  2.89</span></span>
<span><span class="co">##  7 bcg      sex       -0.55  0.09     NA  12724     1 -0.72 -0.37</span></span>
<span><span class="co">##  8 bcg      age:sex    0.04  0.02     NA  12724     1  0     0.08</span></span>
<span><span class="co">##  9 bib      intercept  5.09  0.02     NA  68864     1  5.06  5.12</span></span>
<span><span class="co">## 10 bib      age        3.12  0.01     NA  68864     1  3.11  3.13</span></span>
<span><span class="co">## 11 bib      sex       -0.39  0.02     NA  68864     1 -0.44 -0.35</span></span>
<span><span class="co">## 12 bib      age:sex    0     0.01     NA  68864     1 -0.01  0.02</span></span>
<span><span class="co">## 13 probit   intercept  4.69  0.03     NA 191224     1  4.64  4.74</span></span>
<span><span class="co">## 14 probit   age        3.46  0        NA 191224     1  3.45  3.46</span></span>
<span><span class="co">## 15 probit   sex        0.01  0.04     NA 191224     1 -0.06  0.09</span></span>
<span><span class="co">## 16 probit   age:sex   -0.24  0        NA 191224     1 -0.25 -0.23</span></span>
<span><span class="co">## 17 combined intercept  4.92  0.39     NA 402493     4  4.16  5.68</span></span>
<span><span class="co">## 18 combined age        3.24  0.14     NA 402493     4  2.98  3.51</span></span>
<span><span class="co">## 19 combined sex       -0.15  0.17     NA 402493     4 -0.48  0.19</span></span>
<span><span class="co">## 20 combined age:sex   -0.1   0.06     NA 402493     4 -0.22  0.02</span></span></code></pre>
<p>If we use dh.lmTab it allows us to manipulate our output more easily. For example you might want to split the fixed effects by cohort:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.coef</span><span class="op">$</span><span class="va">fixed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cohort</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html" class="external-link">group_split</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;list_of&lt;</span></span>
<span><span class="co">##   tbl_df&lt;</span></span>
<span><span class="co">##     cohort  : character</span></span>
<span><span class="co">##     variable: character</span></span>
<span><span class="co">##     est     : double</span></span>
<span><span class="co">##     se      : double</span></span>
<span><span class="co">##     pvalue  : double</span></span>
<span><span class="co">##     n_obs   : double</span></span>
<span><span class="co">##     n_coh   : double</span></span>
<span><span class="co">##     lowci   : double</span></span>
<span><span class="co">##     uppci   : double</span></span>
<span><span class="co">##   &gt;</span></span>
<span><span class="co">## &gt;[5]&gt;</span></span>
<span><span class="co">## [[1]]</span></span>
<span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort variable    est    se pvalue  n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 alspac intercept  3.87  0.06     NA 129681     1  3.76  3.98</span></span>
<span><span class="co">## 2 alspac age        3.53  0        NA 129681     1  3.53  3.54</span></span>
<span><span class="co">## 3 alspac sex        0.34  0.08     NA 129681     1  0.18  0.49</span></span>
<span><span class="co">## 4 alspac age:sex   -0.2   0.01     NA 129681     1 -0.21 -0.19</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort variable    est    se pvalue n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 bcg    intercept  6.03  0.06     NA 12724     1  5.91  6.15</span></span>
<span><span class="co">## 2 bcg    age        2.86  0.01     NA 12724     1  2.83  2.89</span></span>
<span><span class="co">## 3 bcg    sex       -0.55  0.09     NA 12724     1 -0.72 -0.37</span></span>
<span><span class="co">## 4 bcg    age:sex    0.04  0.02     NA 12724     1  0     0.08</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort variable    est    se pvalue n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 bib    intercept  5.09  0.02     NA 68864     1  5.06  5.12</span></span>
<span><span class="co">## 2 bib    age        3.12  0.01     NA 68864     1  3.11  3.13</span></span>
<span><span class="co">## 3 bib    sex       -0.39  0.02     NA 68864     1 -0.44 -0.35</span></span>
<span><span class="co">## 4 bib    age:sex    0     0.01     NA 68864     1 -0.01  0.02</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort   variable    est    se pvalue  n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 combined intercept  4.92  0.39     NA 402493     4  4.16  5.68</span></span>
<span><span class="co">## 2 combined age        3.24  0.14     NA 402493     4  2.98  3.51</span></span>
<span><span class="co">## 3 combined sex       -0.15  0.17     NA 402493     4 -0.48  0.19</span></span>
<span><span class="co">## 4 combined age:sex   -0.1   0.06     NA 402493     4 -0.22  0.02</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[5]]</span></span>
<span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort variable    est    se pvalue  n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 probit intercept  4.69  0.03     NA 191224     1  4.64  4.74</span></span>
<span><span class="co">## 2 probit age        3.46  0        NA 191224     1  3.45  3.46</span></span>
<span><span class="co">## 3 probit sex        0.01  0.04     NA 191224     1 -0.06  0.09</span></span>
<span><span class="co">## 4 probit age:sex   -0.24  0        NA 191224     1 -0.25 -0.23</span></span></code></pre>
<p>Or you might want to just select the pooled results:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.coef</span><span class="op">$</span><span class="va">fixed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 4 × 9</span></span>
<span><span class="co">##   cohort   variable    est    se pvalue  n_obs n_coh lowci uppci</span></span>
<span><span class="co">##   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 combined intercept  4.92  0.39     NA 402493     4  4.16  5.68</span></span>
<span><span class="co">## 2 combined age        3.24  0.14     NA 402493     4  2.98  3.51</span></span>
<span><span class="co">## 3 combined sex       -0.15  0.17     NA 402493     4 -0.48  0.19</span></span>
<span><span class="co">## 4 combined age:sex   -0.1   0.06     NA 402493     4 -0.22  0.02</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="random-effects">Random effects<a class="anchor" aria-label="anchor" href="#random-effects"></a>
</h4>
<p>When the model if fit, group (level 2) residuals are calculated for each subject. These represent the difference between interecept of each subject and the mean intercept for the sample.</p>
<p>However, there are not returned by DataSHIELD as they could be disclosive. Instead we can view the standard deviation of these residuals:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1.coef</span><span class="op">$</span><span class="va">random</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 8 × 5</span></span>
<span><span class="co">##   cohort group    var1      var2  stddev</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">## 1 alspac id_int   intercept &lt;NA&gt;    3.84</span></span>
<span><span class="co">## 2 alspac Residual &lt;NA&gt;      &lt;NA&gt;    5.63</span></span>
<span><span class="co">## 3 bcg    id_int   intercept &lt;NA&gt;    1.12</span></span>
<span><span class="co">## 4 bcg    Residual &lt;NA&gt;      &lt;NA&gt;    1.92</span></span>
<span><span class="co">## 5 bib    id_int   intercept &lt;NA&gt;    0.78</span></span>
<span><span class="co">## 6 bib    Residual &lt;NA&gt;      &lt;NA&gt;    1.91</span></span>
<span><span class="co">## 7 probit id_int   intercept &lt;NA&gt;    1.84</span></span>
<span><span class="co">## 8 probit Residual &lt;NA&gt;      &lt;NA&gt;    4.53</span></span></code></pre>
<p>If we take ALSPAC as an example, we have an overall (mean) intercept of 3.87, and a standard deviation of 3.84. This indicates considerable variability between individual intercepts. If you had specified more than one random effect (e.g. slope) this would also be displayed here. We can also see the standard deviation of the residual error, ie the difference between observed values and predicted values within subject.</p>
</div>
</div>
<div class="section level3">
<h3 id="plotting-the-trajectories">Plotting the trajectories<a class="anchor" aria-label="anchor" href="#plotting-the-trajectories"></a>
</h3>
<p>In order to plot trajectories, we first need to get model predicted values of weight. In order to do this, we need to create a dataframe with the values of the fixed effects at which we want to predict values of weight. The names of the columns of this new dataframe need to correspond to the names of the coefficients in the output above.</p>
<p>We want to visualise the trajectories for both males and females between ages 0 and 25. In our reference dataframe, we therefore create values for age between 0 and 25 at 0.1 intervals, repeated for sex == 0 (males) and sex == 1 (females).</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_data_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, </span>
<span>    <span class="st">"age:sex"</span> <span class="op">=</span> <span class="va">age</span><span class="op">*</span><span class="fl">0</span>,</span>
<span>    sex <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_data_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.11</span><span class="op">)</span>, </span>
<span>    <span class="st">"age:sex"</span> <span class="op">=</span> <span class="va">age</span><span class="op">*</span><span class="fl">1</span>,</span>
<span>    sex <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">new_data_m</span>, <span class="va">new_data_f</span><span class="op">)</span></span></code></pre></div>
<p>If we look at this object we have created, it has all the values of the model variables at which we want to predict weight:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_data</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 479 × 3</span></span>
<span><span class="co">##      age `age:sex`   sex</span></span>
<span><span class="co">##    &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">##  1   0           0     0</span></span>
<span><span class="co">##  2   0.1         0     0</span></span>
<span><span class="co">##  3   0.2         0     0</span></span>
<span><span class="co">##  4   0.3         0     0</span></span>
<span><span class="co">##  5   0.4         0     0</span></span>
<span><span class="co">##  6   0.5         0     0</span></span>
<span><span class="co">##  7   0.6         0     0</span></span>
<span><span class="co">##  8   0.7         0     0</span></span>
<span><span class="co">##  9   0.8         0     0</span></span>
<span><span class="co">## 10   0.9         0     0</span></span>
<span><span class="co">## # ℹ 469 more rows</span></span></code></pre>
<p>We can then use this reference data and our model object to get predicted values. Note that we now have four more columns appended to our reference data containing predicted values, standard error of predictions and confidence intervals.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.predictLmer.html">dh.predictLmer</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model1.fit</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">pred_data</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotdata</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 2,395 × 9</span></span>
<span><span class="co">##    cohort intercept   age `age:sex`   sex predicted     se low_ci upper_ci</span></span>
<span><span class="co">##    &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac         1   0           0     0      3.87 0.0562   3.76     3.98</span></span>
<span><span class="co">##  2 alspac         1   0.1         0     0      4.22 0.0560   4.11     4.33</span></span>
<span><span class="co">##  3 alspac         1   0.2         0     0      4.58 0.0558   4.47     4.69</span></span>
<span><span class="co">##  4 alspac         1   0.3         0     0      4.93 0.0557   4.82     5.04</span></span>
<span><span class="co">##  5 alspac         1   0.4         0     0      5.28 0.0555   5.17     5.39</span></span>
<span><span class="co">##  6 alspac         1   0.5         0     0      5.64 0.0553   5.53     5.74</span></span>
<span><span class="co">##  7 alspac         1   0.6         0     0      5.99 0.0551   5.88     6.10</span></span>
<span><span class="co">##  8 alspac         1   0.7         0     0      6.34 0.0550   6.23     6.45</span></span>
<span><span class="co">##  9 alspac         1   0.8         0     0      6.69 0.0548   6.59     6.80</span></span>
<span><span class="co">## 10 alspac         1   0.9         0     0      7.05 0.0547   6.94     7.15</span></span>
<span><span class="co">## # ℹ 2,385 more rows</span></span></code></pre>
<p>Nice, we’re getting there. One thing to address is that currently we have predicted values for all cohorts between ages 0 and 25. However many of the cohorts don’t have data between those ages, so we might not want to plot beyond where there is data. We can trim our predicted data to the available ages.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_trim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.trimPredData.html">dh.trimPredData</a></span><span class="op">(</span></span>
<span>    pred <span class="op">=</span> <span class="va">plotdata</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alspac"</span>, <span class="st">"bcg"</span>, <span class="st">"bib"</span>, <span class="st">"probit"</span>, <span class="st">"combined"</span><span class="op">)</span>,</span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_trim</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 1,343 × 9</span></span>
<span><span class="co">##    cohort intercept   age `age:sex`   sex predicted     se low_ci upper_ci</span></span>
<span><span class="co">##    &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac         1   0           0     0      3.87 0.0562   3.76     3.98</span></span>
<span><span class="co">##  2 alspac         1   0.1         0     0      4.22 0.0560   4.11     4.33</span></span>
<span><span class="co">##  3 alspac         1   0.2         0     0      4.58 0.0558   4.47     4.69</span></span>
<span><span class="co">##  4 alspac         1   0.3         0     0      4.93 0.0557   4.82     5.04</span></span>
<span><span class="co">##  5 alspac         1   0.4         0     0      5.28 0.0555   5.17     5.39</span></span>
<span><span class="co">##  6 alspac         1   0.5         0     0      5.64 0.0553   5.53     5.74</span></span>
<span><span class="co">##  7 alspac         1   0.6         0     0      5.99 0.0551   5.88     6.10</span></span>
<span><span class="co">##  8 alspac         1   0.7         0     0      6.34 0.0550   6.23     6.45</span></span>
<span><span class="co">##  9 alspac         1   0.8         0     0      6.69 0.0548   6.59     6.80</span></span>
<span><span class="co">## 10 alspac         1   0.9         0     0      7.05 0.0547   6.94     7.15</span></span>
<span><span class="co">## # ℹ 1,333 more rows</span></span></code></pre>
<p>Next we set sex as a factor to make the plot clearer:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_trim</span> <span class="op">&lt;-</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>It would also be nice to be able to overlay the predicted trajectory with the observed values. Remember earlier we made a scatter plot using DataSHIELD? We can extract the anonymised values which were used in that plot and store them as a local object. This allows us to build more flexible plots.</p>
<p>Each row of the created object represents the anomyised values of a subject.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.getAnonPlotData.html">dh.getAnonPlotData</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>    var_1 <span class="op">=</span> <span class="st">"age"</span>, </span>
<span>    var_2 <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 804,986 × 3</span></span>
<span><span class="co">##    cohort    age weight</span></span>
<span><span class="co">##    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac  0.130   4.93</span></span>
<span><span class="co">##  2 alspac  0.604   7.37</span></span>
<span><span class="co">##  3 alspac  3.89   18.5 </span></span>
<span><span class="co">##  4 alspac  7.64   26.5 </span></span>
<span><span class="co">##  5 alspac  8.57   30.4 </span></span>
<span><span class="co">##  6 alspac 10.8    39.4 </span></span>
<span><span class="co">##  7 alspac 13.0    56.8 </span></span>
<span><span class="co">##  8 alspac 17.8    84.4 </span></span>
<span><span class="co">##  9 alspac  1.00    9.79</span></span>
<span><span class="co">## 10 alspac  1.36   10.1 </span></span>
<span><span class="co">## # ℹ 804,976 more rows</span></span></code></pre>
<p>Now we are ready to plot the pooled trajectories. We use the function “sample_frac” to only take 1% of the observed values. You can play around with this value, but if you use too many the graph becomes unreadable.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fl">.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">predicted</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Predicted weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Sex"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="plot-model-1-pooled-1.png" alt=""><p class="caption">plot of chunk plot-model-1-pooled</p>
</div>
<p>We can also plot the trajectories for each cohort separately:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fl">.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">predicted</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cohort</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Predicted weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Sex"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="plot-model-1-cohort-1.png" alt=""><p class="caption">plot of chunk plot-model-1-cohort</p>
</div>
<p>Q: Looking at the plots, how well do you think our model fits the data?</p>
</div>
</div>
<div class="section level2">
<h2 id="part-3-fitting-a-non-linear-trajectory-using-a-transformation-of-the-age-term">Part 3: Fitting a non-linear trajectory using a transformation of the age term<a class="anchor" aria-label="anchor" href="#part-3-fitting-a-non-linear-trajectory-using-a-transformation-of-the-age-term"></a>
</h2>
<p>The previous model doesn’t look great to me, especially around age 5 where there looks to be a distinct non-linearity in the trajectory which we are not capturing.</p>
<p>One way to address this is to model weight not as a function of age, but as a function of a transformation of age.</p>
<p>Let’s start by creating a new variable which is age^2, and see if this provides a better fit. We create the variable, and join it back in our main data frame.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.make.html" class="external-link">ds.make</a></span><span class="op">(</span></span>
<span>    toAssign <span class="op">=</span> <span class="st">"data$age^2"</span>, </span>
<span>    newobj <span class="op">=</span> <span class="st">"age_2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.dataFrame.html" class="external-link">ds.dataFrame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"age_2"</span><span class="op">)</span>, </span>
<span>    newobj <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
<p>Now we are going to simply repeat the steps before, but using this transformed variable instead of the original age variable.</p>
<p>First we run the model:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_2.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.lmerSLMA.html" class="external-link">ds.lmerSLMA</a></span><span class="op">(</span></span>
<span>    dataName <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  formula <span class="op">=</span> <span class="st">"weight ~ 1 + age_2 + sex + age_2*sex + (1|id_int)"</span>, </span>
<span>  datasources <span class="op">=</span> <span class="va">conns</span><span class="op">)</span></span></code></pre></div>
<p>Now we create a dataframe of the values of the fixed effects at which we want to predict weight. Note that as we have transformed our age term, we need to add this transformed version of the variable to our reference data.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_ref_2a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, </span>
<span>    age_2 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>    <span class="st">"age_2:sex"</span> <span class="op">=</span> <span class="va">age_2</span><span class="op">*</span><span class="fl">0</span>,</span>
<span>    sex <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ref_2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.11</span><span class="op">)</span>, </span>
<span>    age_2 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>    <span class="st">"age_2:sex"</span> <span class="op">=</span> <span class="va">age_2</span><span class="op">*</span><span class="fl">1</span>,</span>
<span>    sex <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ref_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pred_ref_2a</span>, <span class="va">pred_ref_2b</span><span class="op">)</span></span></code></pre></div>
<p>Again we get the predicted values, trim them at the ages of the observed data and set sex as a factor.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_data_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.predictLmer.html">dh.predictLmer</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">age_2.fit</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">pred_ref_2</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_data_2_trim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.trimPredData.html">dh.trimPredData</a></span><span class="op">(</span></span>
<span>    pred <span class="op">=</span> <span class="va">pred_data_2</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alspac"</span>, <span class="st">"bcg"</span>, <span class="st">"bib"</span>, <span class="st">"probit"</span>, <span class="st">"combined"</span><span class="op">)</span>,</span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_data_2_trim</span> <span class="op">&lt;-</span> <span class="va">pred_data_2_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot this against the observed data and see if it fits any better:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fl">.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_data_2_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">predicted</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Predicted weight"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Sex"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="plot-model-2-1.png" alt=""><p class="caption">plot of chunk plot-model-2</p>
</div>
<p>Hmmm. We now have a non-linear trajectory, but it still doesn’t look a great fit. We haven’t looked at any fit statistics or residuals yet, but from the eye it clearly doesn’t fit the data. It also doesn’t seem to capture the sex differences we would expect. We can do better than this.</p>
</div>
<div class="section level2">
<h2 id="part-4-fractional-polynomials">Part 4: Fractional polynomials<a class="anchor" aria-label="anchor" href="#part-4-fractional-polynomials"></a>
</h2>
<p>Using one transformation of age allowed one ‘bend’ in the trajectory. However, the problem we saw with the previous model is that natural growth trajectories often have multiple bends.</p>
<p>One way to model this is to use two transformations of age (e.g. age^2 and age^0.5). These are called fractional polynomials (powers which involve fractions). You could use more than 2 transformations: this would give you a better model fit, but with greater risk of overfitting your model. Here we will stick two.</p>
<p>Even with only two transformations of age, there are infinite number of possible combinations. How do we chose which to use?</p>
<p>You may have a good a priori reason to chose a combination of terms. If you don’t, one reasonable approach is to select a certain set of transformations, and fit every combination of those. We can then see which combination of age terms provides the best model fit.</p>
<div class="section level3">
<h3 id="preparing-the-data-for-modelling">Preparing the data for modelling<a class="anchor" aria-label="anchor" href="#preparing-the-data-for-modelling"></a>
</h3>
<div class="section level4">
<h4 id="remove-values-of-zero">Remove values of zero<a class="anchor" aria-label="anchor" href="#remove-values-of-zero"></a>
</h4>
<p>Transforming values of zero will create infinite values which will break our models. We add a small quantity to our age variable to avoid this.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.assign.html" class="external-link">ds.assign</a></span><span class="op">(</span></span>
<span>    toAssign <span class="op">=</span> <span class="st">"data$age+0.01"</span>, </span>
<span>    newobj <span class="op">=</span> <span class="st">"age"</span>, </span>
<span>  datasources <span class="op">=</span> <span class="va">conns</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dh.dropCols.html">dh.dropCols</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    vars <span class="op">=</span> <span class="st">"age"</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"remove"</span>, </span>
<span>    new_obj <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.dataFrame.html" class="external-link">ds.dataFrame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"age"</span><span class="op">)</span>, </span>
<span>    newobj <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-transformations-of-age-term">Create transformations of age term<a class="anchor" aria-label="anchor" href="#create-transformations-of-age-term"></a>
</h4>
<p>We could do the transformations manually, but this would be a bit cumbersome. We can insted use the function ds.makeAgePolys to create transformations of age. Here we use the following powers: -2, -1, -0.5, log, 0.5, 2, 3.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dh.makeAgePolys.html">dh.makeAgePolys</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    age_var <span class="op">=</span> <span class="st">"age"</span>, </span>
<span>    poly_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m_2"</span>, <span class="st">"m_1"</span>, <span class="st">"m_0_5"</span>, <span class="st">"log"</span>, <span class="st">"0_5"</span>, <span class="st">"2"</span>, <span class="st">"3"</span><span class="op">)</span>, </span>
<span>    poly_form <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"^-2"</span>, <span class="st">"^-1"</span>, <span class="st">"^-0.5"</span>, <span class="st">"log"</span>, <span class="st">"^0.5"</span>, <span class="st">"^2"</span>, <span class="st">"^3"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can check this has worked, and see the mean values for these new variables.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.getStats.html">dh.getStats</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"agem_2"</span>, <span class="st">"agem_1"</span>, <span class="st">"agem_0_5"</span>, <span class="st">"age_log"</span>, <span class="st">"age0_5"</span>, <span class="st">"age2"</span>, <span class="st">"age3"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly_summary</span><span class="op">$</span><span class="va">continuous</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">cohort</span>, <span class="va">variable</span>, <span class="va">mean</span>, <span class="va">std.dev</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 35 × 4</span></span>
<span><span class="co">##    cohort   variable    mean std.dev</span></span>
<span><span class="co">##    &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac   age_log     2.13    1.3 </span></span>
<span><span class="co">##  2 bcg      age_log     1.25    0.67</span></span>
<span><span class="co">##  3 bib      age_log     0.98    0.73</span></span>
<span><span class="co">##  4 probit   age_log     1.4     1.19</span></span>
<span><span class="co">##  5 alspac   age0_5     69.2    86.8 </span></span>
<span><span class="co">##  6 bcg      age0_5      6.86    8.19</span></span>
<span><span class="co">##  7 bib      age0_5      5.25    8.85</span></span>
<span><span class="co">##  8 probit   age0_5     34.4    72.0 </span></span>
<span><span class="co">##  9 alspac   age2      889.   1393.  </span></span>
<span><span class="co">## 10 bcg      age2       27.0    39.2 </span></span>
<span><span class="co">## 11 bib      age2       22.6    46.0 </span></span>
<span><span class="co">## 12 probit   age2      447.   1125.  </span></span>
<span><span class="co">## 13 alspac   age3        0.78    2.12</span></span>
<span><span class="co">## 14 bcg      age3       -0.04    1.69</span></span>
<span><span class="co">## 15 bib      age3       -0.92    2.15</span></span>
<span><span class="co">## 16 probit   age3       -0.21    2.07</span></span>
<span><span class="co">## 17 alspac   agem_0_5    1.48    2.59</span></span>
<span><span class="co">## 18 bcg      agem_0_5    1.68    2.45</span></span>
<span><span class="co">## 19 bib      agem_0_5    2.95    3.54</span></span>
<span><span class="co">## 20 probit   agem_0_5    2       2.65</span></span>
<span><span class="co">## 21 alspac   agem_1      8.89   26.7 </span></span>
<span><span class="co">## 22 bcg      agem_1      8.84   26.0 </span></span>
<span><span class="co">## 23 bib      agem_1     21.2    38.6 </span></span>
<span><span class="co">## 24 probit   agem_1     11.0    28.0 </span></span>
<span><span class="co">## 25 alspac   agem_2    792.   2688.  </span></span>
<span><span class="co">## 26 bcg      agem_2    754.   2628.  </span></span>
<span><span class="co">## 27 bib      agem_2   1945.   3942.  </span></span>
<span><span class="co">## 28 probit   agem_2    905.   2845.  </span></span>
<span><span class="co">## 29 combined age0_5     39.8  1150   </span></span>
<span><span class="co">## 30 combined age2      504.      2.18</span></span>
<span><span class="co">## 31 combined age3       -0.01    1.23</span></span>
<span><span class="co">## 32 combined age_log     1.56   73.8 </span></span>
<span><span class="co">## 33 combined agem_0_5    1.99    2.84</span></span>
<span><span class="co">## 34 combined agem_1     12.0    30.0 </span></span>
<span><span class="co">## 35 combined agem_2   1042.   3037.</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="identifying-the-best-fitting-model">Identifying the best fitting model<a class="anchor" aria-label="anchor" href="#identifying-the-best-fitting-model"></a>
</h3>
<p>Ok, so now we have a load of transformations of our age in term in the dataframe “data”. Next we want to fit models for each paired combination of these terms. Again, we could do this by writing out ds.lmerSLMA 28 times, but this brings a fair chance that you make an error in the code.</p>
<p>I’ve written a couple more functions to streamline the process.</p>
<div class="section level4">
<h4 id="create-model-formulae">Create model formulae<a class="anchor" aria-label="anchor" href="#create-model-formulae"></a>
</h4>
<p>‘dh.makeLmerForm’ creates the model formulae based on the age terms you have created. The argument to “agevars” is a vector of variable names corresponding to the age transformations we created above.</p>
<p>First we try to find the best shape of trajectory, so we create model formulae just with the age terms.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.makeLmerForm.html">dh.makeLmerForm</a></span><span class="op">(</span></span>
<span>  outcome <span class="op">=</span> <span class="st">"weight"</span>, </span>
<span>  id_var <span class="op">=</span> <span class="st">"id_int"</span>, </span>
<span>  age_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"agem_2"</span>, <span class="st">"agem_1"</span>, <span class="st">"agem_0_5"</span>, <span class="st">"age_log"</span>, <span class="st">"age0_5"</span>, <span class="st">"age2"</span>, <span class="st">"age3"</span><span class="op">)</span>, </span>
<span>  random <span class="op">=</span> <span class="st">"intercept"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight_form</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 10 × 2</span></span>
<span><span class="co">##    polys           formula                               </span></span>
<span><span class="co">##    &lt;chr[1d]&gt;       &lt;chr&gt;                                 </span></span>
<span><span class="co">##  1 age,agem_2      weight~1+ age+agem_2 + (1|id_int)     </span></span>
<span><span class="co">##  2 age,agem_1      weight~1+ age+agem_1 + (1|id_int)     </span></span>
<span><span class="co">##  3 age,agem_0_5    weight~1+ age+agem_0_5 + (1|id_int)   </span></span>
<span><span class="co">##  4 age,age_log     weight~1+ age+age_log + (1|id_int)    </span></span>
<span><span class="co">##  5 age,age0_5      weight~1+ age+age0_5 + (1|id_int)     </span></span>
<span><span class="co">##  6 age,age2        weight~1+ age+age2 + (1|id_int)       </span></span>
<span><span class="co">##  7 age,age3        weight~1+ age+age3 + (1|id_int)       </span></span>
<span><span class="co">##  8 agem_2,agem_1   weight~1+ agem_2+agem_1 + (1|id_int)  </span></span>
<span><span class="co">##  9 agem_2,agem_0_5 weight~1+ agem_2+agem_0_5 + (1|id_int)</span></span>
<span><span class="co">## 10 agem_2,age_log  weight~1+ agem_2+age_log + (1|id_int)</span></span></code></pre>
<p>This has created a table where each row (a total of 28) contains the formula for a mixed effects model with a different combination of the fractional polynomials.</p>
</div>
</div>
<div class="section level3">
<h3 id="fit-all-combinations-of-polynomials">Fit all combinations of polynomials<a class="anchor" aria-label="anchor" href="#fit-all-combinations-of-polynomials"></a>
</h3>
<p>The function dh.lmeMultPoly takes as an input to the argument “formulae” a vector of formulae. Here we use the formulae created above. You could also create your own vector of formulae and supply it to the same argument.</p>
<p>If you’ve read Rachel Hughes’ paper, you’ll notice that she first fits models on a discovery sample, and then checks the fit on the remaining sample. I’ve skipped this here for simplicity but it is possible to do this in DS.</p>
<p>This will take a few minutes as we are fitting 28 different models.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.lmeMultPoly.html">dh.lmeMultPoly</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>    formulae <span class="op">=</span> <span class="va">weight_form</span><span class="op">$</span><span class="va">formula</span>, </span>
<span>  poly_names <span class="op">=</span> <span class="va">weight_form</span><span class="op">$</span><span class="va">polys</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in dh.lmeMultPoly(df = "data", formulae = weight_form$formulae, : object 'weight_form' not found</span></span></code></pre>
<p>There are some converegence warnings. We can see details here:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly.fit</span><span class="op">$</span><span class="va">convergence</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 28 × 4</span></span>
<span><span class="co">##    poly            completed message all_converged</span></span>
<span><span class="co">##    &lt;chr[1d]&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;lgl&gt;        </span></span>
<span><span class="co">##  1 age,agem_2      TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  2 age,agem_1      TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  3 age,agem_0_5    TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  4 age,age_log     TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  5 age,age0_5      TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  6 age,age2        TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  7 age,age3        TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">##  8 agem_2,agem_1   TRUE      &lt;NA&gt;    FALSE        </span></span>
<span><span class="co">##  9 agem_2,agem_0_5 TRUE      &lt;NA&gt;    FALSE        </span></span>
<span><span class="co">## 10 agem_2,age_log  TRUE      &lt;NA&gt;    TRUE         </span></span>
<span><span class="co">## # ℹ 18 more rows</span></span></code></pre>
<p>The output contains a table with the negative log likelihood for each model in each study, the average rank of that model across all studies and the summed negative log likelihood. The model with the lowest summed log-likelhood across studies contains two powers: age^0.5 &amp; age^2.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly.fit</span><span class="op">$</span><span class="va">fit</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 28 × 6</span></span>
<span><span class="co">##    model          alspac     bcg      bib   probit   sum_log</span></span>
<span><span class="co">##    &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">##  1 age0_5,age2  -413072. -25053. -136400. -555192. -1129718.</span></span>
<span><span class="co">##  2 age,age2     -414380. -24847. -135066. -562074. -1136366.</span></span>
<span><span class="co">##  3 age0_5,age3  -418867. -25055. -136595. -557293. -1137810.</span></span>
<span><span class="co">##  4 age,age3     -414581. -25326. -138701. -560576. -1139183.</span></span>
<span><span class="co">##  5 age,age0_5   -418305. -25019. -135347. -569398. -1148069.</span></span>
<span><span class="co">##  6 age,age_log  -419968. -25864. -139284. -570858. -1155973.</span></span>
<span><span class="co">##  7 age,agem_0_5 -420377. -26508. -142164. -570741. -1159790.</span></span>
<span><span class="co">##  8 age,agem_1   -420403. -26741. -143292. -570683. -1161119.</span></span>
<span><span class="co">##  9 age,agem_2   -420409. -26825. -143753. -570701. -1161687.</span></span>
<span><span class="co">## 10 age_log,age2 -419517. -27708. -151222. -565902. -1164349.</span></span>
<span><span class="co">## # ℹ 18 more rows</span></span></code></pre>
<p>In this scenario we are trying to fit the same model to all cohorts. In other scenarioes you might want to fit a different model to different cohorts. You could still use this table as a reference for the best fitting model, for example for alspac:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly.fit</span><span class="op">$</span><span class="va">fit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">alspac</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">alspac</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 28 × 2</span></span>
<span><span class="co">##    model          alspac</span></span>
<span><span class="co">##    &lt;chr&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">##  1 age0_5,age2  -413072.</span></span>
<span><span class="co">##  2 age,age2     -414380.</span></span>
<span><span class="co">##  3 age,age3     -414581.</span></span>
<span><span class="co">##  4 age,age0_5   -418305.</span></span>
<span><span class="co">##  5 age0_5,age3  -418867.</span></span>
<span><span class="co">##  6 age_log,age2 -419517.</span></span>
<span><span class="co">##  7 age,age_log  -419968.</span></span>
<span><span class="co">##  8 age2,age3    -420299.</span></span>
<span><span class="co">##  9 age,agem_0_5 -420377.</span></span>
<span><span class="co">## 10 age,agem_1   -420403.</span></span>
<span><span class="co">## # ℹ 18 more rows</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="final-model">Final model<a class="anchor" aria-label="anchor" href="#final-model"></a>
</h3>
<p>Ok, so we’ve got an idea what the best fitting combination of age terms will be. Now we can fit our final model, including sex and the interaction with the age terms. We aren’t worrying about other covariates in this example, but of course you could include them.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dsBaseClient/man/ds.lmerSLMA.html" class="external-link">ds.lmerSLMA</a></span><span class="op">(</span></span>
<span>    dataName <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  formula <span class="op">=</span> <span class="st">"weight ~ 1 + age0_5 + age2 + sex + age0_5*sex + age2*sex + (1|id_int)"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="making-plots">Making plots<a class="anchor" aria-label="anchor" href="#making-plots"></a>
</h3>
<p>Now we can go through the same process as above to make our plot. Again, we need to create our age transformations in the new data to get the predicted values for weight at each age.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_ref_final_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, </span>
<span>    age0_5 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">0.5</span>,</span>
<span>    age2 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">2</span>, </span>
<span>    sex <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="st">"age0_5:sex"</span> <span class="op">=</span> <span class="va">age0_5</span><span class="op">*</span><span class="va">sex</span>, </span>
<span>  <span class="st">"age2:sex"</span> <span class="op">=</span> <span class="va">age2</span><span class="op">*</span><span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ref_final_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, </span>
<span>    age0_5 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">0.5</span>,</span>
<span>    age2 <span class="op">=</span> <span class="va">age</span><span class="op">^</span><span class="fl">2</span>, </span>
<span>    sex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="st">"age0_5:sex"</span> <span class="op">=</span> <span class="va">age0_5</span><span class="op">*</span><span class="va">sex</span>, </span>
<span>  <span class="st">"age2:sex"</span> <span class="op">=</span> <span class="va">age2</span><span class="op">*</span><span class="va">sex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_ref_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pred_ref_final_m</span>, <span class="va">pred_ref_final_f</span><span class="op">)</span></span></code></pre></div>
<p>Again we get the predicted values, trim them at the ages of the observed data and set sex as a factor.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_ref_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.predictLmer.html">dh.predictLmer</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">final.fit</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">pred_ref_final</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_ref_final_trim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.trimPredData.html">dh.trimPredData</a></span><span class="op">(</span></span>
<span>    pred <span class="op">=</span> <span class="va">pred_ref_final</span>,</span>
<span>    coh_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alspac"</span>, <span class="st">"bcg"</span>, <span class="st">"bib"</span>, <span class="st">"probit"</span>, <span class="st">"combined"</span><span class="op">)</span>,</span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_ref_final_trim</span> <span class="op">&lt;-</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sex</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And now we can make some plots</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fl">.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">predicted</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">==</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Predicted weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Sex"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="plot-model-3-pooled-1.png" alt=""><p class="caption">plot of chunk plot-model-3-pooled</p>
</div>
<p>We can also plot the trajectories by cohort</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fl">.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">predicted</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort</span> <span class="op">!=</span> <span class="st">"combined"</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, ymin <span class="op">=</span> <span class="va">low_ci</span>, ymax <span class="op">=</span> <span class="va">upper_ci</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cohort</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Child age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Predicted weight (KG)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Sex"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="plot-model-3-cohort-1.png" alt=""><p class="caption">plot of chunk plot-model-3-cohort</p>
</div>
<p>Great, this looks like a much better fit. We have captured the initial growth, followed by a reduction in growth rate at age 5 followed by an increase into adolescence.</p>
<p>This model still isn’t perfect - looking at the graph what problem can you see?</p>
</div>
</div>
<div class="section level2">
<h2 id="checking-model-fit">Checking model fit<a class="anchor" aria-label="anchor" href="#checking-model-fit"></a>
</h2>
<p>The final step is to check how well the model fits at different age points. Here we can approximate Table 2 from Tilling et al. (2014) “Modelling Childhood Growth …”.</p>
<p>First we get mean observed values for weight between different age bands. The ‘intervals’ argument specifies how we want to bin our age variable. Again this takes a few minutes to run.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_by_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dh.meanByGroup.html">dh.meanByGroup</a></span><span class="op">(</span></span>
<span>    df <span class="op">=</span> <span class="st">"data"</span>, </span>
<span>    outcome <span class="op">=</span> <span class="st">"weight"</span>, </span>
<span>    group_var <span class="op">=</span> <span class="st">"age"</span>, </span>
<span>    intervals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">10</span>, <span class="fl">11</span>, <span class="fl">15</span>, <span class="fl">16</span>, <span class="fl">18</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_by_age</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 19 × 6</span></span>
<span><span class="co">##    cohort group  mean std.dev nvalid nmissing</span></span>
<span><span class="co">##    &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 alspac 0_1    5.79    2.08  37577    92104</span></span>
<span><span class="co">##  2 bcg    0_1    6.12    1.92   4949     7775</span></span>
<span><span class="co">##  3 bib    0_1    5.39    1.88  40931    27933</span></span>
<span><span class="co">##  4 probit 0_1    5.94    1.99 102981    88243</span></span>
<span><span class="co">##  5 alspac 11_15 48.6    11.3   20591   109090</span></span>
<span><span class="co">##  6 probit 11_15 41.6     9.89  13109   178115</span></span>
<span><span class="co">##  7 alspac 16_18 67.3    13.9    4299   125382</span></span>
<span><span class="co">##  8 probit 16_18 62.9    12.5    7962   183262</span></span>
<span><span class="co">##  9 alspac 1_2   12.0     1.98  10065   119616</span></span>
<span><span class="co">## 10 bcg    1_2   11.1     2.19   1882    10842</span></span>
<span><span class="co">## 11 bib    1_2   11.8     2.34   7927    60937</span></span>
<span><span class="co">## 12 probit 1_2   11.1     2.39  17930   173294</span></span>
<span><span class="co">## 13 alspac 3_5   17.0     2.48  14382   115299</span></span>
<span><span class="co">## 14 bcg    3_5   16.6     2.66   3582     9142</span></span>
<span><span class="co">## 15 bib    3_5   17.6     2.73  11164    57700</span></span>
<span><span class="co">## 16 probit 3_5   16.9     2.51  13378   177846</span></span>
<span><span class="co">## 17 alspac 6_10  29.1     7.07  20138   109543</span></span>
<span><span class="co">## 18 bib    6_10  25.6     4.33    409    68455</span></span>
<span><span class="co">## 19 probit 6_10  23.0     4.10  14980   176244</span></span></code></pre>
<p>We rename our column to ‘observed’:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">observed_by_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>observed <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<p>Now we get the average predicted values between the same age bands</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_by_age</span> <span class="op">&lt;-</span> <span class="va">pred_ref_final_trim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">age</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"0_1"</span>, </span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"1_2"</span>, </span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"3_5"</span>, </span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">6</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">10</span> <span class="op">~</span> <span class="st">"6_10"</span>, </span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">11</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">15</span> <span class="op">~</span> <span class="st">"11_15"</span>, </span>
<span>        <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">16</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">18</span> <span class="op">~</span> <span class="st">"16_18"</span><span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">cohort</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    predicted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">predicted</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    low_ci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">low_ci</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    upper_ci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">upper_ci</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_by_age</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 24 × 5</span></span>
<span><span class="co">## # Groups:   group [6]</span></span>
<span><span class="co">##    group cohort   predicted low_ci upper_ci</span></span>
<span><span class="co">##    &lt;chr&gt; &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1 0_1   alspac        7.33   7.22     7.44</span></span>
<span><span class="co">##  2 0_1   bcg           7.57   7.45     7.69</span></span>
<span><span class="co">##  3 0_1   bib           7.38   7.35     7.41</span></span>
<span><span class="co">##  4 0_1   combined      7.41  NA       NA   </span></span>
<span><span class="co">##  5 0_1   probit        7.31   7.26     7.36</span></span>
<span><span class="co">##  6 11_15 alspac       48.9   48.8     49.0 </span></span>
<span><span class="co">##  7 11_15 combined     42.2   NA       NA   </span></span>
<span><span class="co">##  8 11_15 probit       47     46.9     47.1 </span></span>
<span><span class="co">##  9 16_18 alspac       68.7   68.6     68.9 </span></span>
<span><span class="co">## 10 16_18 combined     56.9   NA       NA   </span></span>
<span><span class="co">## # ℹ 14 more rows</span></span></code></pre>
<p>Finally we join the observed and predicted values into one table, and calculate the difference between the two. We can also use the confidence intervals to calculate upper and lower bounds of the residual. You can see that model fit isn’t great for PROBIT towards the extremes. For other cohorts, the looks pretty good.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred_by_age</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"group"</span>, <span class="st">"cohort"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    difference <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">-</span> <span class="va">predicted</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    lower_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">-</span> <span class="va">upper_ci</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    higher_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">-</span> <span class="va">low_ci</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>        <span class="va">group</span>, </span>
<span>        levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0_1"</span>, <span class="st">"1_2"</span>, <span class="st">"3_5"</span>, <span class="st">"6_10"</span>, <span class="st">"11_15"</span>, <span class="st">"16_18"</span><span class="op">)</span>,</span>
<span>        ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lower_res</span>, <span class="st">" to "</span>, <span class="va">higher_res</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">predicted</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">cohort</span>, <span class="va">observed</span>, <span class="va">predicted</span>, <span class="va">difference</span>, <span class="va">limits</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cohort</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="va">group_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_tab</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;list_of&lt;</span></span>
<span><span class="co">##   tbl_df&lt;</span></span>
<span><span class="co">##     group     : ordered&lt;59289&gt;</span></span>
<span><span class="co">##     cohort    : character</span></span>
<span><span class="co">##     observed  : double</span></span>
<span><span class="co">##     predicted : double</span></span>
<span><span class="co">##     difference: double</span></span>
<span><span class="co">##     limits    : character</span></span>
<span><span class="co">##   &gt;</span></span>
<span><span class="co">## &gt;[4]&gt;</span></span>
<span><span class="co">## $alspac</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   group cohort observed predicted difference limits        </span></span>
<span><span class="co">##   &lt;ord&gt; &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;         </span></span>
<span><span class="co">## 1 0_1   alspac     5.79      7.33      -1.54 -1.65 to -1.43</span></span>
<span><span class="co">## 2 1_2   alspac    12.0      10.9        1.11 1.01 to 1.22  </span></span>
<span><span class="co">## 3 3_5   alspac    17.0      17.4       -0.49 -0.6 to -0.38 </span></span>
<span><span class="co">## 4 6_10  alspac    29.1      29.4       -0.25 -0.36 to -0.14</span></span>
<span><span class="co">## 5 11_15 alspac    48.6      48.9       -0.24 -0.35 to -0.13</span></span>
<span><span class="co">## 6 16_18 alspac    67.3      68.7       -1.46 -1.61 to -1.3 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bcg</span></span>
<span><span class="co">## # A tibble: 3 × 6</span></span>
<span><span class="co">##   group cohort observed predicted difference limits        </span></span>
<span><span class="co">##   &lt;ord&gt; &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;         </span></span>
<span><span class="co">## 1 0_1   bcg        6.12      7.57      -1.45 -1.57 to -1.33</span></span>
<span><span class="co">## 2 1_2   bcg       11.1      11.4       -0.29 -0.41 to -0.17</span></span>
<span><span class="co">## 3 3_5   bcg       16.6      16.9       -0.27 -0.4 to -0.15 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $bib</span></span>
<span><span class="co">## # A tibble: 3 × 6</span></span>
<span><span class="co">##   group cohort observed predicted difference limits        </span></span>
<span><span class="co">##   &lt;ord&gt; &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;         </span></span>
<span><span class="co">## 1 0_1   bib        5.39      7.38      -1.99 -2.02 to -1.96</span></span>
<span><span class="co">## 2 1_2   bib       11.8      11.1        0.7  0.67 to 0.74  </span></span>
<span><span class="co">## 3 3_5   bib       17.6      17.2        0.41 0.37 to 0.44  </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $probit</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   group cohort observed predicted difference limits        </span></span>
<span><span class="co">##   &lt;ord&gt; &lt;chr&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;         </span></span>
<span><span class="co">## 1 0_1   probit     5.94      7.31      -1.37 -1.42 to -1.32</span></span>
<span><span class="co">## 2 1_2   probit    11.1      10.7        0.45 0.4 to 0.5    </span></span>
<span><span class="co">## 3 3_5   probit    16.9      16.9       -0.02 -0.08 to 0.04 </span></span>
<span><span class="co">## 4 6_10  probit    23.0      28.3       -5.32 -5.38 to -5.25</span></span>
<span><span class="co">## 5 11_15 probit    41.6      47         -5.38 -5.46 to -5.31</span></span>
<span><span class="co">## 6 16_18 probit    62.9      66.1       -3.15 -3.26 to -3.04</span></span></code></pre>
<p>Finish by logging out of the demo server</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://datashield.github.io/DSI/reference/datashield.logout.html" class="external-link">datashield.logout</a></span><span class="op">(</span><span class="va">conns</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tim Cadman.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
